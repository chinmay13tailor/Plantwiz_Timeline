<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>

  .spinner{
  width:28px;
  height:28px;
  border:3px solid #c7d2fe;
  border-top:3px solid #2563eb;
  border-radius:50%;
  animation:spin .9s linear infinite;
}
@keyframes spin{
  to{ transform:rotate(360deg); }
}

/* ================= BASE ================= */
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:#f4f7fb;
  color:#1f2937;
}
.container{
  max-width:1400px;
  margin:20px auto;
  padding:24px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.08);
  position: relative;   
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  font-size:22px;
  font-weight:700;
  color:#2563eb;
}
.subtitle{
  font-size:14px;
  color:#64748b;
}

/* ================= CONTROLS ================= */
.controls{
  display:flex;
  gap:10px;
  margin-top:18px;
}
.btn{
  padding:8px 16px;
  border-radius:10px;
  border:1px solid #c7d2fe;
  background:#f8fafc;
  font-weight:600;
  cursor:pointer;
}
.btn.active{
  background:#2563eb;
  color:#fff;
}

/* ================= TIMELINE ================= */
.timeline-wrapper{
  position:relative;
  margin:26px 0 18px;
}
.timeline-line{
  height:4px;
  background:#e5e7eb;
  border-radius:2px;
}
.timeline-progress{
  position:absolute;
  top:0;
  left:0;
  height:4px;
  width:0%;
  border-radius:2px;
  background:linear-gradient(90deg,#3b82f6,#60a5fa,#3b82f6);
  background-size:200% 100%;
  animation:flow 2.5s linear infinite;
}
@keyframes flow{
  0%{background-position:0% 50%}
  100%{background-position:200% 50%}
}
.timeline-dots{
  position:absolute;
  top:-6px;
  left:0;
  right:0;
  display:grid;
  grid-template-columns:repeat(6,1fr);
}
.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  margin:auto;
}
.dot.good{background:#22c55e}
.dot.warning{background:#f59e0b}
.dot.critical{background:#ef4444}

/* ================= CURRENT TIME PIN ================= */
.time-pin{
  position:absolute;
  top:-10px;
  transform:translateX(-50%);
  z-index:5;
}
.pin-icon{
  width:20px;
  height:20px;
  border-radius:50% 50% 50% 0;
  transform:rotate(-45deg);
  position:relative;
}
.pin-icon::after{
  content:"";
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:6px;
  left:6px;
}
.pin-good{background:#22c55e}
.pin-warning{background:#f59e0b}
.pin-critical{background:#ef4444}

  .datePicker{
  margin-top:10px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-family:inherit;
}

  
/* ================= BLOCKS ================= */
.timeline{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:16px;
}
.block{
  border-radius:14px;
  padding:14px;
  border:2px solid #e5e7eb;
  background:#f9fafb;
  cursor:pointer;
  transition:.2s ease;
}
.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}
.block-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.metric{margin-top:8px;font-size:14px}
.chevron{
  font-size:14px;
  transition:.3s;
}
.block.active .chevron{
  transform:rotate(180deg);
}

/* ================= DETAILS ================= */
.details{
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height .55s ease, opacity .4s ease;
}
.details.active{
  max-height:360px;
  opacity:1;
}
.details-box{
  margin-top:18px;
  border-radius:16px;
  padding:18px;
  border:2px solid;
}
.details.good{border-color:#22c55e;background:#f0fdf4}
.details.warning{border-color:#f59e0b;background:#fffbeb}
.details.critical{border-color:#ef4444;background:#fef2f2}

.details-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

/* ===== DETAILS SECTION TITLES ===== */
.details-section-head{
  display:grid;
  grid-template-columns:1fr 1fr 1.5fr;
  gap:14px;
  margin-bottom:10px;
  font-size:13px;
  font-weight:600;
  color:#334155;
}
.details-section-head span{
  display:flex;
  align-items:center;
  gap:6px;
}

.details-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1.5fr;
  gap:14px;
}
.info-box{
  background:#fff;
  padding:14px;
  border-radius:12px;
  border:1px solid #e5e7eb;
}
.cta{
  margin-top:14px;
  background:#2563eb;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
}

/* ================= SUMMARY ================= */
.summary{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-top:22px;
}
.summary-card{
  padding:16px;
  border-radius:14px;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  text-align:center;
}
  /* ===== Detailed Analysis Header (Figma style) ===== */
/* ===== Detailed Analysis Header (Exact Figma Style) ===== */
.da-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:20px 22px;
  border-radius:16px 16px 0 0;
}

/* LEFT */
.da-left{
  display:flex;
  align-items:flex-start;
  gap:14px;
}

/* ICON */
.da-icon{
  width:42px;
  height:42px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border:2px solid currentColor;
}

/* TEXT */
.da-title{
  font-size:18px;
  font-weight:700;
}

.da-subtitle{
  margin-top:2px;
  font-size:13px;
  color:#64748b;
}

/* STATUS PILL */
.da-status{
  display:inline-block;
  margin-top:10px;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  border:1.5px solid currentColor;
  background:#fff;
}

/* CLOSE */
.da-close{
  font-size:22px;
  cursor:pointer;
  color:#94a3b8;
}

/* ===== STATUS THEMES ===== */
/* ===== Header background by status (Figma style) ===== */
.good .da-header{
  background:linear-gradient(
    180deg,
    #ecfdf3 0%,
    #f0fdf4 100%
  );
  color:#15803d;
}

.warning .da-header{
  background:linear-gradient(
    180deg,
    #fff7ed 0%,
    #fffbeb 100%
  );
  color:#c2410c;
}

.critical .da-header{
  background:linear-gradient(
    180deg,
    #fef2f2 0%,
    #fff1f2 100%
  );
  color:#b91c1c;
}

  .analysis-card{
  width:680px;
  max-height:90vh;
  background:#fff;
  border-radius:16px;
  overflow:auto;
  box-shadow:0 20px 50px rgba(0,0,0,.3);
}

</style>
</head>

<body>

  <!-- ================= LOADING ================= -->


<div class="container">
<div id="loading" style="
  display:none;
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(2px);
  z-index:50;
  align-items:center;
  justify-content:center;
  font-weight:600;
  color:#2563eb;
">
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="spinner"></div>
    Loading data‚Ä¶
  </div>
</div>
<div class="header">
  <div>
    <div class="brand">Plantwiz</div>
    <div class="subtitle">Production Timeline</div>
  </div>
  <div class="subtitle" id="viewLabel">Viewing: Today</div>
</div>

<div class="controls">
  <div class="btn active" id="btnToday"> Today</div>
  <div class="btn" id="btnYesterday">Yesterday</div>
  <div class="btn" id="btnCustom">Custom Date</div>
  <input type="date" id="datePicker" style="display:none">
</div>

<div class="timeline-wrapper">
  <div class="timeline-line"></div>
  <div id="timeline-progress" class="timeline-progress"></div>
  <div id="time-pin" class="time-pin"><div class="pin-icon"></div></div>
  <div id="dots" class="timeline-dots"></div>
</div>

<div id="timeline" class="timeline"></div>
<div id="details" class="details"></div>
<div id="summary" class="summary"></div>

  
</div>

  <!-- ================= DETAILED ANALYSIS MODAL ================= -->
<div id="analysisModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9999;
  align-items:center;
  justify-content:center;
">

  <div class="analysis-card">

<!-- ===== HEADER ===== -->
<div id="daHeader" class="da-header">
  <div class="da-left">
    <div class="da-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M4 19V10M10 19V5M16 19V14M22 19H2"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </svg>
    </div>

    <div>
      <div class="da-title">Detailed Analysis</div>
      <div id="modalTime" class="da-subtitle"></div>

      <!-- STATUS BADGE (LEFT, BELOW TITLE) -->
      <span id="modalStatus" class="da-status">Status</span>
    </div>
  </div>

  <span class="da-close" onclick="closeAnalysis()">√ó</span>
</div>
    <!-- ===== KEY METRICS ===== -->
    <div style="padding:16px 20px">
      <h4>Key Metrics</h4>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
        <div>
          <strong id="mPerformance">0%</strong><br>Performance
        </div>
        <div>
          <strong id="mActual">0</strong><br>Actual
        </div>
        <div>
          <strong id="mDowntime">0</strong><br>Downtime
        </div>
      </div>
    </div>

    <!-- ===== INSIGHT ===== -->
    <div style="padding:0 20px 20px">
      <h4>Insight</h4>
      <p id="modalReason"></p>
      <ul id="modalFindings"></ul>
    </div>

  </div>
</div>


<script>
/* ================= CONFIG ================= */
const API="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=[
  "Meter_Run_Per_Min","Consumption_Per_Min","deltaexpectedproduction",
  "Runtime","Downtime","Idletime",
  "deltaperformance","deltaavailability","deltaquality","deltaoee"
];
const BLOCKS=["00‚Äì04","04‚Äì08","08‚Äì12","12‚Äì16","16‚Äì20","20‚Äì24"];
const JWT=new URLSearchParams(location.search).get("token");

let activeIndex=null;
let selectedDate=new Date();

/* ================= HELPERS ================= */
const avg=a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0;

/* ================= FETCH ================= */
async function fetchData(date){
  const d=new Date(date);
  const start=new Date(d.toDateString()).getTime();
  const end=start+86400000-1;
  const url=`${API}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${start}&endTs=${end}&agg=NONE&limit=5000`;
  const r=await fetch(url,{headers:{ "X-Authorization":`Bearer ${JWT}` }});
  return r.json();
}

/* ================= MERGE ================= */
function mergeTelemetry(raw){
  const map={};
  Object.entries(raw).forEach(([k,a])=>{
    a.forEach(p=>{
      if(!map[p.ts]) map[p.ts]={ts:p.ts};
      map[p.ts][k]=Number(p.value);
    });
  });
  return Object.values(map);
}

/* ================= AGGREGATE ================= */
function aggregate(rows){
  const blocks=[...Array(6)].map(()=>({actual:0,expected:0,downtime:0,p:[],o:[]}));
  rows.forEach(p=>{
    const i=Math.floor(new Date(p.ts).getHours()/4);
    const b=blocks[i];
    b.actual+=p.Meter_Run_Per_Min||0;
    b.expected+=p.deltaexpectedproduction||0;
    b.downtime+=p.Downtime||0;
    if(p.deltaperformance!=null)b.p.push(p.deltaperformance);
    if(p.deltaoee!=null)b.o.push(p.deltaoee);
  });
  return blocks.map(b=>{
    const perfPct=b.expected?(b.actual/b.expected)*100:0;
    let s="good";
    if(b.downtime>60)s="critical";
    else if(perfPct<90)s="warning";
    return{...b,s,perf:avg(b.p),oee:avg(b.o)};
  });
}

/* ================= RENDER ================= */
function render(blocks){
  const tl=document.getElementById("timeline");
  const dots=document.getElementById("dots");
  tl.innerHTML=""; dots.innerHTML="";
  blocks.forEach((b,i)=>{
    dots.innerHTML+=`<div class="dot ${b.s}"></div>`;
    const el=document.createElement("div");
    el.className=`block ${b.s}`;
    el.innerHTML=`
      <div class="block-header">
        <strong>${BLOCKS[i]}</strong>
        <span class="chevron">‚åÑ</span>
      </div>
      <div class="metric">Performance ${b.perf.toFixed(1)}%</div>
      <div class="metric">${Math.round(b.actual)} / ${Math.round(b.expected)} mtr</div>
      <div class="metric">Downtime ${b.downtime} min</div>
    `;
    el.onclick=()=>toggleDetails(blocks,i);
    tl.appendChild(el);
  });
}

/* ================= TOGGLE DETAILS ================= */
function toggleDetails(blocks,i){
  const d=document.getElementById("details");
  const cards=[...document.querySelectorAll(".block")];

  if(activeIndex===i){ closeDetails(); return; }

  cards.forEach(c=>c.classList.remove("active"));
  cards[i].classList.add("active");

  const b=blocks[i];
  activeIndex=i;

  d.className=`details active ${b.s}`;
  d.innerHTML=`
    <div class="details-box ${b.s}">
      <div class="details-header">
        <strong>Time Block: ${BLOCKS[i]}</strong>
        <span style="cursor:pointer" onclick="closeDetails()">√ó</span>
      </div>

      <div class="details-section-head">
        <span>üìä Production Status</span>
        <span>‚è± Downtime Status</span>
        <span>üí° Quick Insight</span>
      </div>

      <div class="details-grid">
        <div class="info-box">
          <strong>${b.actual>=b.expected?"Ahead":"Behind"} Target</strong><br>
          ${Math.abs(Math.round(b.actual-b.expected))} mtr
        </div>
        <div class="info-box">
          <strong>Total Downtime</strong><br>
          ${b.downtime} min
        </div>
        <div class="info-box">
          ${b.s==="good"
            ?"Great job! Production is on track."
            :b.s==="warning"
            ?"You're close to target. Reduce minor stoppages."
            :"Production is lagging. Focus on downtime reduction."}
        </div>
      </div>

      <button class="cta">View Detailed Analysis</button>
    </div>
  `;
const viewBtn = d.querySelector(".cta");
if (viewBtn) {
  viewBtn.onclick = () => openAnalysis({
    label: BLOCKS[i],
    actual: b.actual,
    expected: b.expected,
    perf: b.perf,
    downtime: b.downtime,
    zone: b.s === "good"
      ? "Good"
      : b.s === "warning"
        ? "Warning"
        : "Critical"
  });
}
}

function closeDetails(){
  document.getElementById("details").classList.remove("active");
  document.querySelectorAll(".block").forEach(b=>b.classList.remove("active"));
  activeIndex=null;
}

/* ================= SUMMARY ================= */
function renderSummary(blocks){
  const exp=blocks.reduce((a,b)=>a+b.expected,0);
  const act=blocks.reduce((a,b)=>a+b.actual,0);
  const down=blocks.reduce((a,b)=>a+b.downtime,0);
  const oee=avg(blocks.map(b=>b.oee));
  document.getElementById("summary").innerHTML=`
    <div class="summary-card">Total Expected<br><strong>${Math.round(exp)} mtr</strong></div>
    <div class="summary-card">Total Actual<br><strong>${Math.round(act)} mtr</strong></div>
    <div class="summary-card">Total Downtime<br><strong>${down} min</strong></div>
    <div class="summary-card">Overall Status<br><strong>${oee.toFixed(1)}%</strong></div>
  `;
}

/* ================= TIME PIN ================= */
function updateTime(blocks){
  const now=new Date();
  const m=now.getHours()*60+now.getMinutes();
  const pct=(m/1440)*100;
  document.getElementById("time-pin").style.left=pct+"%";
  document.getElementById("timeline-progress").style.width=pct+"%";
  const s=blocks[Math.floor(now.getHours()/4)]?.s||"good";
  document.querySelector(".pin-icon").className=`pin-icon pin-${s}`;
}

/* ================= LOAD ================= */
  function showLoading(){
  document.getElementById("loading").style.display="flex";
}

function hideLoading(){
  document.getElementById("loading").style.display="none";
}

async function loadTimeline(date){
  closeDetails();
  selectedDate = date;

  showLoading();                    // üîë ADD

  try {
    const raw = await fetchData(date);
    const rows = mergeTelemetry(raw);
    const blocks = aggregate(rows);
    render(blocks);
    renderSummary(blocks);
    updateTime(blocks);
  } finally {
    hideLoading();                  // üîë ADD
  }
}

/* ================= DETAILED ANALYSIS MODAL ================= */
function openAnalysis(block){
  const modal = document.getElementById("analysisModal");
  const card  = modal.querySelector(".analysis-card");

  modal.style.display = "flex";

  /* ================= RESET & APPLY STATE ================= */
  card.classList.remove("good","warning","critical");

  const state =
    block.zone === "Good" ? "good" :
    block.zone === "Warning" ? "warning" :
    "critical";

  card.classList.add(state);

  /* ================= HEADER ================= */
  document.getElementById("modalTime").textContent =
    `Time Block: ${block.label}`;

  const statusEl = document.getElementById("modalStatus");
  statusEl.textContent = `Status: ${block.zone}`;

  /* ================= METRICS ================= */
  document.getElementById("mPerformance").textContent =
    `${block.perf.toFixed(1)}%`;

  document.getElementById("mActual").textContent =
    `${Math.round(block.actual)} mtr`;

  document.getElementById("mDowntime").textContent =
    `${block.downtime} min`;

  /* ================= INSIGHT ================= */
  document.getElementById("modalReason").textContent =
    block.zone === "Good"
      ? "Production is on track. Keep the consistency."
      : block.zone === "Warning"
        ? "You are close to target. Minor improvements required."
        : "Production is lagging. Immediate attention required.";

  /* ================= FINDINGS ================= */
  document.getElementById("modalFindings").innerHTML = `
    <li>Expected production: ${Math.round(block.expected)} mtr</li>
    <li>Actual production: ${Math.round(block.actual)} mtr</li>
    <li>Performance: ${block.perf.toFixed(1)}%</li>
    <li>Downtime: ${block.downtime} minutes</li>
  `;
}


function closeAnalysis(){
  document.getElementById("analysisModal").style.display = "none";
}
  


/* ================= BUTTONS ================= */
function setActive(btn){
  document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

btnToday.onclick = () => {
  setActive(btnToday);
  viewLabel.textContent = "Viewing: Today";
  datePicker.style.display = "none";
  loadTimeline(new Date());
};

btnYesterday.onclick = () => {
  setActive(btnYesterday);
  const d = new Date(Date.now() - 86400000);
  datePicker.style.display = "none";
  viewLabel.textContent = "Viewing: Yesterday";
  loadTimeline(d);
};

/* üîë FIX: Custom Date button click handler */
btnCustom.onclick = () => {
  setActive(btnCustom);
  datePicker.style.display = "inline-block";
  datePicker.focus();
};

datePicker.onchange = e => {
  if (!e.target.value) return;

  const d = new Date(e.target.value);
  viewLabel.textContent = `Viewing: ${e.target.value}`;
  datePicker.style.display = "none";
  loadTimeline(d);
};


/* ================= INIT ================= */
(async()=>{
  if(!JWT) return alert("JWT missing");
  await loadTimeline(new Date());
})();
</script>
</body>
</html>
