<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ================= BASE ================= */
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:#f4f7fb;
  color:#1f2937;
}
.container{
  max-width:1400px;
  margin:20px auto;
  padding:24px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.08);
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  font-size:22px;
  font-weight:700;
  color:#2563eb;
}
.subtitle{
  font-size:14px;
  color:#64748b;
}

/* ================= CONTROLS ================= */
.controls{
  display:flex;
  gap:10px;
  margin-top:18px;
}
.btn{
  padding:8px 16px;
  border-radius:10px;
  border:1px solid #c7d2fe;
  background:#f8fafc;
  font-weight:600;
  cursor:pointer;
}
.btn.active{
  background:#2563eb;
  color:#fff;
}

/* ================= TIMELINE ================= */
.timeline-wrapper{
  position:relative;
  margin:26px 0 16px;
}
.timeline-line{
  height:4px;
  background:#e5e7eb;
  border-radius:2px;
}
.timeline-progress{
  position:absolute;
  top:0;
  left:0;
  height:4px;
  width:0%;
  border-radius:2px;
  background:linear-gradient(90deg,#3b82f6,#60a5fa,#3b82f6);
  background-size:200% 100%;
  animation:flow 2.5s linear infinite;
}
@keyframes flow{
  0%{background-position:0% 50%}
  100%{background-position:200% 50%}
}
.timeline-dots{
  position:absolute;
  top:-6px;
  left:0;
  right:0;
  display:grid;
  grid-template-columns:repeat(6,1fr);
}
.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  margin:auto;
}
.dot.good{background:#22c55e}
.dot.warning{background:#f59e0b}
.dot.critical{background:#ef4444}

/* ================= CURRENT TIME PIN ================= */
.time-pin{
  position:absolute;
  top:-10px;
  transform:translateX(-50%);
  z-index:5;
}
.pin-icon{
  width:20px;
  height:20px;
  border-radius:50% 50% 50% 0;
  transform:rotate(-45deg);
  position:relative;
}
.pin-icon::after{
  content:"";
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:6px;
  left:6px;
}
.pin-good{background:#22c55e}
.pin-warning{background:#f59e0b}
.pin-critical{background:#ef4444}

/* ================= BLOCKS ================= */
.timeline{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:16px;
}
.block{
  border-radius:14px;
  padding:14px;
  border:2px solid #e5e7eb;
  background:#f9fafb;
  cursor:pointer;
}
.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}
.block-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.status{
  font-size:12px;
  padding:4px 10px;
  border-radius:20px;
  color:#fff;
}
.good .status{background:#22c55e}
.warning .status{background:#f59e0b}
.critical .status{background:#ef4444}
.metric{margin-top:8px}

/* ================= DETAILS ================= */
.details{
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height .5s ease,opacity .4s ease;
}
.details.active{
  max-height:500px;
  opacity:1;
}
.details-box{
  margin-top:18px;
  border-radius:16px;
  padding:18px;
  border:2px solid;
}
.details.good{border-color:#22c55e;background:#f0fdf4}
.details.warning{border-color:#f59e0b;background:#fffbeb}
.details.critical{border-color:#ef4444;background:#fef2f2}
.details-top{
  display:flex;
  justify-content:space-between;
}
.details-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
  margin-top:14px;
}
.card{
  background:#fff;
  padding:12px;
  border-radius:12px;
  border:1px solid #e5e7eb;
}
.insight{
  margin-top:14px;
  font-weight:600;
}

/* ================= SUMMARY ================= */
.summary{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-top:20px;
}
.summary-card{
  padding:16px;
  border-radius:14px;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div>
    <div class="brand">Plantwiz</div>
    <div class="subtitle">Production Timeline</div>
  </div>
  <div class="subtitle">Viewing: Today</div>
</div>

<div class="controls">
  <div class="btn active">Current Day (Today)</div>
  <div class="btn">Yesterday</div>
  <div class="btn">Custom Date</div>
</div>

<div class="timeline-wrapper">
  <div class="timeline-line"></div>
  <div id="timeline-progress" class="timeline-progress"></div>
  <div id="time-pin" class="time-pin"><div class="pin-icon"></div></div>
  <div id="dots" class="timeline-dots"></div>
</div>

<div id="timeline" class="timeline"></div>
<div id="details" class="details"></div>
<div id="summary" class="summary"></div>

</div>

<script>
/* ================= CONFIG ================= */
const API="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=[
"Meter_Run_Per_Min","Consumption_Per_Min","deltaexpectedproduction",
"Runtime","Downtime","Idletime",
"deltaperformance","deltaavailability","deltaquality","deltaoee"
];
const BLOCKS=["00–04","04–08","08–12","12–16","16–20","20–24"];
const JWT=new URLSearchParams(location.search).get("token");

/* ================= HELPERS ================= */
const avg=a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0;

/* ================= FETCH ================= */
async function fetchData(){
  const d=new Date();
  const start=new Date(d.toDateString()).getTime();
  const end=start+86400000-1;
  const url=`${API}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${start}&endTs=${end}&agg=NONE&limit=5000`;
  const r=await fetch(url,{headers:{ "X-Authorization":`Bearer ${JWT}` }});
  return r.json();
}

/* ================= MERGE (CRITICAL FIX) ================= */
function mergeTelemetry(raw){
  const map={};
  Object.entries(raw).forEach(([key,arr])=>{
    arr.forEach(p=>{
      if(!map[p.ts]) map[p.ts]={ts:p.ts};
      map[p.ts][key]=Number(p.value);
    });
  });
  return Object.values(map);
}

/* ================= AGGREGATE ================= */
function aggregate(rows){
  const blocks=[...Array(6)].map(()=>({
    actual:0,expected:0,energy:0,
    runtime:0,downtime:0,idle:0,
    p:[],a:[],q:[],o:[]
  }));

  rows.forEach(p=>{
    const i=Math.floor(new Date(p.ts).getHours()/4);
    const b=blocks[i];
    b.actual+=p.Meter_Run_Per_Min||0;
    b.expected+=p.deltaexpectedproduction||0;
    b.energy+=p.Consumption_Per_Min||0;
    b.runtime+=p.Runtime||0;
    b.downtime+=p.Downtime||0;
    b.idle+=p.Idletime||0;
    if(p.deltaperformance!=null)b.p.push(p.deltaperformance);
    if(p.deltaavailability!=null)b.a.push(p.deltaavailability);
    if(p.deltaquality!=null)b.q.push(p.deltaquality);
    if(p.deltaoee!=null)b.o.push(p.deltaoee);
  });

  return blocks.map(b=>{
    const perfPct=b.expected?(b.actual/b.expected)*100:0;
    let s="good";
    if(b.downtime>60)s="critical";
    else if(perfPct<90)s="warning";
    return{
      ...b,
      s,
      perf:avg(b.p),
      oee:avg(b.o)
    };
  });
}

/* ================= RENDER ================= */
function render(blocks){
  const tl=document.getElementById("timeline");
  const dots=document.getElementById("dots");
  tl.innerHTML="";dots.innerHTML="";
  blocks.forEach((b,i)=>{
    dots.innerHTML+=`<div class="dot ${b.s}"></div>`;
    const el=document.createElement("div");
    el.className=`block ${b.s}`;
    el.innerHTML=`
      <div class="block-header">
        <strong>${BLOCKS[i]}</strong>
        <div class="status">${b.s.toUpperCase()}</div>
      </div>
      <div class="metric">Performance ${b.perf.toFixed(1)}%</div>
      <div class="metric">${Math.round(b.actual)} / ${Math.round(b.expected)} mtr</div>
      <div class="metric">Downtime ${b.downtime} min</div>`;
    el.onclick=()=>toggleDetails(b,i);
    tl.appendChild(el);
  });
}

/* ================= DETAILS ================= */
function toggleDetails(b,i){
  const d=document.getElementById("details");
  d.className=`details active ${b.s}`;
  d.innerHTML=`
    <div class="details-box ${b.s}">
      <div class="details-top">
        <strong>Time Block: ${BLOCKS[i]}</strong>
        <span style="cursor:pointer" onclick="document.getElementById('details').classList.remove('active')">×</span>
      </div>
      <div class="details-grid">
        <div class="card">Actual<br><strong>${Math.round(b.actual)} mtr</strong></div>
        <div class="card">Expected<br><strong>${Math.round(b.expected)} mtr</strong></div>
        <div class="card">Energy<br><strong>${b.energy.toFixed(1)}</strong></div>
        <div class="card">Runtime<br><strong>${b.runtime} min</strong></div>
        <div class="card">Downtime<br><strong>${b.downtime} min</strong></div>
        <div class="card">Idle<br><strong>${b.idle} min</strong></div>
      </div>
      <div class="insight">
        ${b.s==="good"?"Great job! Production is on track.":
          b.s==="warning"?"You're close to target. Reduce minor stoppages.":
          "Production is lagging. Focus on downtime reduction."}
      </div>
    </div>`;
}

/* ================= SUMMARY ================= */
function renderSummary(blocks){
  const s=document.getElementById("summary");
  const exp=blocks.reduce((a,b)=>a+b.expected,0);
  const act=blocks.reduce((a,b)=>a+b.actual,0);
  const down=blocks.reduce((a,b)=>a+b.downtime,0);
  const oee=avg(blocks.map(b=>b.oee));
  s.innerHTML=`
    <div class="summary-card">Total Expected<br><strong>${Math.round(exp)} mtr</strong></div>
    <div class="summary-card">Total Actual<br><strong>${Math.round(act)} mtr</strong></div>
    <div class="summary-card">Total Downtime<br><strong>${down} min</strong></div>
    <div class="summary-card">Overall Status<br><strong>${oee.toFixed(1)}%</strong></div>`;
}

/* ================= TIME PIN ================= */
function updateTimeIndicator(blocks){
  const pin=document.getElementById("time-pin");
  const icon=pin.firstElementChild;
  const prog=document.getElementById("timeline-progress");
  const now=new Date(Date.now()+19800000);
  const m=now.getUTCHours()*60+now.getUTCMinutes();
  const pct=(m/1440)*100;
  pin.style.left=pct+"%";
  prog.style.width=pct+"%";
  const s=blocks[Math.floor(now.getUTCHours()/4)]?.s||"good";
  icon.className=`pin-icon pin-${s}`;
}

/* ================= INIT ================= */
(async()=>{
  if(!JWT) return alert("JWT missing");
  const raw=await fetchData();
  const rows=mergeTelemetry(raw);   // ✅ FIX
  const blocks=aggregate(rows);
  render(blocks);
  renderSummary(blocks);
  updateTimeIndicator(blocks);
  setInterval(()=>updateTimeIndicator(blocks),60000);
})();
</script>
</body>
</html>
