<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  .spinner{
  width:28px;
  height:28px;
  border:3px solid #c7d2fe;
  border-top:3px solid #2563eb;
  border-radius:50%;
  animation:spin .9s linear infinite;
}
@keyframes spin{
  to{ transform:rotate(360deg); }
}

/* ================= BASE ================= */
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:#f4f7fb;
  color:#1f2937;
}
.container{
  max-width:1400px;
  margin:20px auto;
  padding:24px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.08);
  position: relative;   
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  font-size:22px;
  font-weight:700;
  color:#2563eb;
}
.subtitle{
  font-size:14px;
  color:#64748b;
}

/* ================= CONTROLS ================= */
.controls{
  display:flex;
  gap:10px;
  margin-top:18px;
}
.btn{
  padding:8px 16px;
  border-radius:10px;
  border:1px solid #c7d2fe;
  background:#f8fafc;
  font-weight:600;
  cursor:pointer;
}
.btn.active{
  background:#2563eb;
  color:#fff;
}

/* ================= TIMELINE ================= */
.timeline-wrapper{
  position:relative;
  margin:26px 0 18px;
}
.timeline-line{
  height:4px;
  background:#e5e7eb;
  border-radius:2px;
}
.timeline-progress{
  position:absolute;
  top:0;
  left:0;
  height:4px;
  width:0%;
  border-radius:2px;
  background:linear-gradient(90deg,#3b82f6,#60a5fa,#3b82f6);
  background-size:200% 100%;
  animation:flow 2.5s linear infinite;
}
@keyframes flow{
  0%{background-position:0% 50%}
  100%{background-position:200% 50%}
}
.timeline-dots{
  position:absolute;
  top:-6px;
  left:0;
  right:0;
  display:grid;
  grid-template-columns:repeat(6,1fr);
}
.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  margin:auto;
}
.dot.good{background:#22c55e}
.dot.warning{background:#f59e0b}
.dot.critical{background:#ef4444}

/* ================= CURRENT TIME PIN ================= */
.time-pin{
  position:absolute;
  top:-10px;
  transform:translateX(-50%);
  z-index:5;
}
.pin-icon{
  width:20px;
  height:20px;
  border-radius:50% 50% 50% 0;
  transform:rotate(-45deg);
  position:relative;
}
.pin-icon::after{
  content:"";
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:6px;
  left:6px;
}
.pin-good{background:#22c55e}
.pin-warning{background:#f59e0b}
.pin-critical{background:#ef4444}

  .datePicker{
  margin-top:10px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-family:inherit;
}

  
/* ================= BLOCKS ================= */
.timeline{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:16px;
}
.block{
  border-radius:14px;
  padding:14px;
  border:2px solid #e5e7eb;
  background:#f9fafb;
  cursor:pointer;
  transition:.2s ease;
}
.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}
.block-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.metric{margin-top:8px;font-size:14px}
.chevron{
  font-size:14px;
  transition:.3s;
}
.block.active .chevron{
  transform:rotate(180deg);
}

/* ================= DETAILS ================= */
.details{
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height .55s ease, opacity .4s ease;
}
.details.active{
  max-height:360px;
  opacity:1;
}
.details-box{
  margin-top:18px;
  border-radius:16px;
  padding:18px;
  border:2px solid;
}
.details.good{border-color:#22c55e;background:#f0fdf4}
.details.warning{border-color:#f59e0b;background:#fffbeb}
.details.critical{border-color:#ef4444;background:#fef2f2}

.details-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

/* ===== DETAILS SECTION TITLES ===== */
.details-section-head{
  display:grid;
  grid-template-columns:1fr 1fr 1.5fr;
  gap:14px;
  margin-bottom:10px;
  font-size:13px;
  font-weight:600;
  color:#334155;
}
.details-section-head span{
  display:flex;
  align-items:center;
  gap:6px;
}

.details-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1.5fr;
  gap:14px;
}
.info-box{
  background:#fff;
  padding:14px;
  border-radius:12px;
  border:1px solid #e5e7eb;
}
.cta{
  margin-top:14px;
  background:#2563eb;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
}

/* ================= SUMMARY ================= */
.summary{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-top:22px;
}
.summary-card{
  padding:16px;
  border-radius:14px;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  text-align:center;
}
  /* ===== Detailed Analysis Header (Figma style) ===== */
/* ===== Detailed Analysis Header (Exact Figma Style) ===== */
.da-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:20px 22px;
  border-radius:16px 16px 0 0;
}

/* LEFT */
.da-left{
  display:flex;
  align-items:flex-start;
  gap:14px;
}

/* ICON */
.da-icon{
  width:42px;
  height:42px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  border:2px solid currentColor;
}

/* TEXT */
.da-title{
  font-size:18px;
  font-weight:700;
}

.da-subtitle{
  margin-top:2px;
  font-size:13px;
  color:#64748b;
}

/* STATUS PILL */
.da-status{
  display:inline-block;
  margin-top:10px;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  border:1.5px solid currentColor;
  background:#fff;
}

/* CLOSE */
.da-close{
  font-size:22px;
  cursor:pointer;
  color:#94a3b8;
}

/* ===== STATUS THEMES ===== */
/* ===== Header background by status (Figma style) ===== */
.good .da-header{
  background:linear-gradient(
    180deg,
    #ecfdf3 0%,
    #f0fdf4 100%
  );
  color:#15803d;
}

.warning .da-header{
  background:linear-gradient(
    180deg,
    #fff7ed 0%,
    #fffbeb 100%
  );
  color:#c2410c;
}

.critical .da-header{
  background:linear-gradient(
    180deg,
    #fef2f2 0%,
    #fff1f2 100%
  );
  color:#b91c1c;
}

  .analysis-card{
  width:680px;
  max-height:90vh;
  background:#fff;
  border-radius:16px;
  overflow:auto;
  box-shadow:0 20px 50px rgba(0,0,0,.3);
}
  /* ===== Detailed Analysis : Key Performance Metrics ===== */

.da-metrics{
  padding:18px 20px;
}

.da-metrics-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:14px;
  display:flex;
  align-items:center;
  gap:6px;
}

.da-metrics-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}

.da-metric-card{
  background:#f8fafc;
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
}

.da-metric-card.blue{
  background:#f5faff;
  border-color:#c7d2fe;
}

.da-metric-card.green{
  background:#f0fdf4;
  border-color:#bbf7d0;
}

.da-metric-label{
  font-size:13px;
  color:#64748b;
  margin-bottom:6px;
}

.da-metric-value{
  font-size:22px;
  font-weight:700;
  color:#111827;
}

.da-metric-card.green .da-metric-value{
  color:#15803d;
}

.da-metric-sub{
  font-size:12px;
  color:#64748b;
  margin-top:2px;
}
/* ===== ZONE CLASSIFICATION ===== */
.zone-section{
  padding:0 20px 20px;
}

.zone-title{
  font-size:14px;
  font-weight:700;
  color:#334155;
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:10px;
}

.zone-box{
  padding:16px;
  border-radius:14px;
  border:2px solid;
}

.zone-headline{
  font-weight:700;
  margin-bottom:6px;
}

.zone-message{
  font-size:14px;
  margin-bottom:12px;
}

.zone-reasons{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
}

/* GOOD */
.zone-good{
  background:#ecfdf3;
  border-color:#22c55e;
  color:#166534;
}

/* WARNING */
.zone-warning{
  background:#fff7ed;
  border-color:#f59e0b;
  color:#92400e;
}

/* CRITICAL */
.zone-critical{
  background:#fef2f2;
  border-color:#ef4444;
  color:#7f1d1d;
}
/* ===== Detailed Findings ===== */
.df-card{
  margin-bottom:14px;
  padding:14px 16px;
  border-radius:12px;
  border:1px solid;
  background:#f8fafc;
  font-size:14px;
}

.df-card ul{
  margin:8px 0 0 18px;
  padding:0;
}

.df-card li{
  margin-bottom:6px;
}

/* Color themes */
.df-prod{
  border-color:#c7d2fe;
  background:#f5f7ff;
}

.df-down{
  border-color:#86efac;
  background:#f0fdf4;
}

.df-eff{
  border-color:#bfdbfe;
  background:#eff6ff;
}

  /* ================= END OF DAY PROJECTION ================= */

.eod-card{
  margin-top:26px;
  border-radius:18px;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  overflow:hidden;
}

.eod-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 20px;
  background:linear-gradient(90deg,#4f46e5,#3b82f6);
  color:#fff;
}

.eod-title{
  font-size:16px;
  font-weight:700;
}

.eod-subtitle{
  font-size:13px;
  opacity:.85;
}

.eod-time{
  text-align:right;
}

.eod-time-label{
  font-size:12px;
  opacity:.8;
}

.eod-time-value{
  font-size:14px;
  font-weight:700;
}

.eod-body{
  display:grid;
  grid-template-columns:repeat(2, minmax(320px, 1fr));
  gap:20px;
  padding:20px;
}


.eod-box{
  background:#fff;
  border-radius:14px;
  padding:16px;
  border:2px solid;
}

.eod-box.warning{
  border-color:#f59e0b;
  background:#fffbeb;
}

.eod-box.critical{
  border-color:#ef4444;
  background:#fef2f2;
}

.eod-box-title{
  font-size:14px;
  font-weight:600;
  margin-bottom:8px;
}

.eod-main-value{
  font-size:28px;
  font-weight:800;
  margin-bottom:4px;
}

.eod-sub-text{
  font-size:13px;
  color:#64748b;
}

.eod-meta{
  margin-top:12px;
  font-size:13px;
}

.eod-meta div{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.status-text{
  font-weight:700;
  color:#b91c1c;
}

.eod-shortfall{
  margin:0 20px;
  padding:12px 16px;
  background:#fff7ed;
  border:1px solid #fed7aa;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  font-weight:700;
  color:#9a3412;
}

.eod-insights{
  margin:16px 20px 20px;
  padding:14px 16px;
  background:#eff6ff;
  border:1px solid #bfdbfe;
  border-radius:14px;
}

.eod-insights-title{
  font-weight:700;
  margin-bottom:8px;
}

.eod-insights ul{
  margin:0;
  padding-left:18px;
  font-size:13px;
  color:#334155;
}

  /* ===== Projected Production ‚Äì UI ===== */
/* ===== Unified Projection Card ===== */

.eod-projection-card{
  border-radius:16px;
  padding:16px 18px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.proj-header{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  font-weight:600;
}

.proj-icon{
  font-size:16px;
}

.proj-main-line{
  display:flex;
  align-items:baseline;
  gap:8px;
}

.proj-main-value{
  font-size:34px;
  font-weight:800;
}

.proj-main-unit{
  font-size:13px;
  opacity:0.75;
}

.proj-meta-panel{
  border-radius:10px;
  padding:10px 12px;
  font-size:13px;
}

.proj-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}

.proj-row:last-child{
  margin-bottom:0;
}

.proj-divider{
  border-top:1px solid;
  opacity:0.4;
}

.proj-footer{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  font-weight:600;
}
.prod-theme{
  background:#fffbeb;
  border:2px solid #f59e0b;
}

.prod-theme .proj-header,
.prod-theme .proj-footer{
  color:#92400e;
}

.prod-theme .proj-main-value{
  color:#d97706;
}

.prod-theme .proj-meta-panel{
  background:#fff7ed;
}

.prod-theme .proj-divider{
  border-color:#fed7aa;
}
.down-theme{
  background:#fef2f2;
  border:2px solid #ef4444;
}

.down-theme .proj-header,
.down-theme .proj-footer{
  color:#991b1b;
}

.down-theme .proj-main-value{
  color:#dc2626;
}

.down-theme .proj-meta-panel{
  background:#fff1f2;
}

.down-theme .proj-divider{
  border-color:#fecaca;
}
</style>
</head>
<body>
  <!-- ================= LOADING ================= -->
<div class="container">
<div id="loading" style="
  display:none;
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(2px);
  z-index:50;
  align-items:center;
  justify-content:center;
  font-weight:600;
  color:#2563eb;
">
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="spinner"></div>
    Loading data‚Ä¶
  </div>
</div>
<div class="header">
  <div>
    <div class="brand">Plantwiz</div>
    <div class="subtitle">Production Timeline</div>
  </div>
  <div class="subtitle" id="viewLabel">Viewing: Today</div>
</div>

<div class="controls">
  <div class="btn active" id="btnToday"> Today</div>
  <div class="btn" id="btnYesterday">Yesterday</div>
  <div class="btn" id="btnCustom">Custom Date</div>
  <input type="date" id="datePicker" style="display:none">
</div>

<div class="timeline-wrapper">
  <div class="timeline-line"></div>
  <div id="timeline-progress" class="timeline-progress"></div>
  <div id="time-pin" class="time-pin"><div class="pin-icon"></div></div>
  <div id="dots" class="timeline-dots"></div>
</div>

<div id="timeline" class="timeline"></div>
<div id="details" class="details"></div>
<div id="summary" class="summary"></div>
<!-- ================= END OF DAY PROJECTION ================= -->
<div class="eod-card">

  <!-- HEADER -->
  <div class="eod-header">
    <div>
      <div class="eod-title">End of Day Projection</div>
      <div class="eod-subtitle">Based on current performance trends</div>
    </div>

    <div class="eod-time">
      <div class="eod-time-label">Time Elapsed</div>
      <div class="eod-time-value">-- / 24h</div>
    </div>
  </div>
  <!-- TWO COLUMN GRID -->
  <div class="eod-body">

    <!-- Projected Production -->
<div class="eod-projection-card prod-theme" id="eodProdBox">
  <div class="proj-header">
    <span class="proj-icon">‚ö†Ô∏è</span>
    <span class="proj-title">Projected Production</span>
  </div>

  <div class="proj-main-line">
    <span class="proj-main-value" id="eodProjectedProd">--</span>
    <span class="proj-main-unit">mtr by EOD</span>
  </div>

  <div class="proj-meta-panel">
    <div class="proj-row">
      <span>Avg. Production Rate</span>
      <span id="eodProdRate">--</span>
    </div>
    <div class="proj-row">
      <span>Remaining Time</span>
      <span id="eodRemainingTime">--</span>
    </div>
       <div class="proj-row">
      <span></span>
      <span id="eodRemainingTime"></span>
    </div>
  </div>

  <div class="proj-divider"></div>

  <div class="proj-footer">
    <span>Expected Performance</span>
    <span id="eodExpectedPerf">--%</span>
  </div>
</div>

<div class="eod-projection-card down-theme" id="eodDownBox">
  <div class="proj-header">
    <span class="proj-icon">‚ö†Ô∏è</span>
    <span class="proj-title">Projected Downtime</span>
  </div>

  <div class="proj-main-line">
    <span class="proj-main-value" id="eodProjectedDown">--</span>
    <span class="proj-main-unit">min by EOD</span>
  </div>

  <div class="proj-meta-panel">
    <div class="proj-row">
      <span>Avg. Downtime / Block</span>
      <span id="eodDownRate">--</span>
    </div>
    <div class="proj-row">
      <span>Downtime So Far</span>
      <span id="eodDownSoFar">--</span>
    </div>
    <div class="proj-row">
      <span>Blocks Analyzed</span>
      <span id="eodDownBlocks">--</span>
    </div>
  </div>

  <div class="proj-divider"></div>

  <div class="proj-footer">
    <span>Status</span>
    <span id="eodDownStatus">--</span>
  </div>
</div>




  </div> <!-- END eod-body -->

  <!-- SHORTFALL (FULL WIDTH) -->
  <div class="eod-shortfall">
    Projected Shortfall
    <strong>--</strong>
  </div>

  <!-- INSIGHTS (FULL WIDTH) -->
  <div class="eod-insights">
    <div class="eod-insights-title">Smart Insights</div>
    <ul>
      <li>Projection will appear once data is analyzed.</li>
      <li>Current efficiency trends will be used.</li>
      <li>Final output depends on remaining time.</li>
    </ul>
  </div>

</div>


  
</div>

  <!-- ================= DETAILED ANALYSIS MODAL ================= -->
<div id="analysisModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9999;
  align-items:center;
  justify-content:center;
">

  <div class="analysis-card">

<!-- ===== HEADER ===== -->
<div id="daHeader" class="da-header">
  <div class="da-left">
    <div class="da-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M4 19V10M10 19V5M16 19V14M22 19H2"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </svg>
    </div>

    <div>
      <div class="da-title">Detailed Analysis</div>
      <div id="modalTime" class="da-subtitle"></div>

      <!-- STATUS BADGE (LEFT, BELOW TITLE) -->
      <span id="modalStatus" class="da-status">Status</span>
    </div>
  </div>

  <span class="da-close" onclick="closeAnalysis()">√ó</span>
</div>
<div class="da-metrics">
  <div class="da-metrics-title">
    ‚ö° Key Performance Metrics
  </div>

  <div class="da-metrics-grid">

    <div class="da-metric-card blue">
      <div class="da-metric-label">Performance Rate</div>
      <div class="da-metric-value" id="mPerformance">0%</div>
      <div class="da-metric-sub">of target achieved</div>
    </div>

    <div class="da-metric-card">
      <div class="da-metric-label">Production Output</div>
      <div class="da-metric-value" id="mActual">0</div>
      <div class="da-metric-sub">mtr produced</div>
    </div>

    <div class="da-metric-card green">
      <div class="da-metric-label">Downtime</div>
      <div class="da-metric-value" id="mDowntime">0</div>
      <div class="da-metric-sub">minutes</div>
    </div>

  </div>
</div>
<!-- ===== ZONE CLASSIFICATION ===== -->
<div id="zoneSection" class="zone-section">
  <div class="zone-title">
    ‚ö†Ô∏è Zone Classification
  </div>

  <div id="zoneBox" class="zone-box">
    <div id="zoneHeadline" class="zone-headline"></div>
    <div id="zoneMessage" class="zone-message"></div>

    <div class="zone-reasons">
      <div id="zoneReasonPerf" class="zone-reason"></div>
      <div id="zoneReasonDown" class="zone-reason"></div>
    </div>
  </div>
</div>
    <!-- ===== DETAILED FINDINGS ===== -->
<div style="padding:0 20px 24px">

  <h4 style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
    üìä Detailed Findings
  </h4>

  <!-- Production Analysis -->
  <div class="df-card df-prod">
    <strong>üìà Production Analysis</strong>
    <ul>
      <li>Expected production: <b id="dfExp"></b></li>
      <li>Actual production: <b id="dfAct"></b></li>
      <li id="dfDelta"></li>
    </ul>
  </div>

  <!-- Downtime Analysis -->
  <div class="df-card df-down">
    <strong>‚è± Downtime Analysis</strong>
    <ul>
      <li>Total downtime recorded: <b id="dfDown"></b></li>
      <li>Acceptable downtime limit: <b id="dfLimit"></b></li>
      <li id="dfMargin"></li>
      <li id="dfImpact"></li>
    </ul>
  </div>

  <!-- Efficiency Breakdown -->
  <div class="df-card df-eff">
    <strong>‚ö° Efficiency Breakdown</strong>
    <ul>
      <li>Operational time: <b id="dfRun"></b></li>
      <li>Production rate: <b id="dfRate"></b></li>
      <li>Target rate: <b id="dfTarget"></b></li>
      <li>Rate variance: <b id="dfVar"></b></li>
    </ul>
  </div>


  </div>

<!-- ===== SMART RECOMMENDATIONS ===== -->
<div id="smartRecoWrap" style="padding:0 20px 22px">
  <h4 style="display:flex;align-items:center;gap:8px">
    üìà Smart Recommendations
  </h4>

  <div id="smartRecoBox" style="
    margin-top:10px;
    padding:14px 16px;
    border-radius:12px;
    border:1px solid #bfdbfe;
    background:#eff6ff;
  ">
    <p id="smartRecoMain" style="margin:0 0 8px;font-weight:600"></p>

    <div style="font-size:13px;color:#334155;margin-bottom:6px">
      Additional Actions:
    </div>
    <ul id="smartRecoList" style="margin:0;padding-left:18px"></ul>
  </div>
</div>

  </div>

</div>


<script>
/* ================= CONFIG ================= */
const API="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=[
  "Meter_Run_Per_Min","Consumption_Per_Min","deltaexpectedproduction",
  "Runtime","Downtime","Idletime",
  "deltaperformance","deltaavailability","deltaquality","deltaoee"
];
const BLOCKS=["00‚Äì04","04‚Äì08","08‚Äì12","12‚Äì16","16‚Äì20","20‚Äì24"];
const JWT=new URLSearchParams(location.search).get("token");

let activeIndex=null;
let selectedDate=new Date();

/* ================= HELPERS ================= */
const avg=a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0;

/* ================= FETCH ================= */
async function fetchData(date){
  const d=new Date(date);
  const start=new Date(d.toDateString()).getTime();
  const end=start+86400000-1;
  const url=`${API}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${start}&endTs=${end}&agg=NONE&limit=5000`;
  const r=await fetch(url,{headers:{ "X-Authorization":`Bearer ${JWT}` }});
  return r.json();
}

/* ================= MERGE ================= */
function mergeTelemetry(raw){
  const map={};
  Object.entries(raw).forEach(([k,a])=>{
    a.forEach(p=>{
      if(!map[p.ts]) map[p.ts]={ts:p.ts};
      map[p.ts][k]=Number(p.value);
    });
  });
  return Object.values(map);
}
function calculateMinorDowntimeByBlock(rows) {

  const minorByBlock = Array(6).fill(0);

  let streak = 0;
  let streakBlock = null;

  for (let i = 0; i < rows.length; i++) {

    const r = rows[i];
    const isDown = (r.Downtime || 0) > 0;
    const blockIndex = Math.floor(new Date(r.ts).getHours() / 4);

    if (isDown) {
      if (streak === 0) streakBlock = blockIndex;
      streak++;
    }

    // streak ends OR last row
    if (!isDown || i === rows.length - 1) {

      // Minor downtime = continuous ‚â§ 10 minutes
      if (streak > 0 && streak <= 10 && streakBlock !== null) {
        minorByBlock[streakBlock] += streak;
      }

      streak = 0;
      streakBlock = null;
    }
  }

  return minorByBlock; // minutes per block
}
function calculateProjectedDowntime(rows, blocks) {

  const now = new Date();
  const currentBlock = Math.floor(now.getHours() / 4);
  const analysedBlocks = Math.min(currentBlock + 1, 6);

  // 1Ô∏è‚É£ Total downtime till now (all downtime)
  const totalDowntimeTillNow = blocks
    .slice(0, analysedBlocks)
    .reduce((s, b) => s + b.downtime, 0);

  // 2Ô∏è‚É£ Minor downtime only
  const minorByBlock = calculateMinorDowntimeByBlock(rows);
  const minorTillNow = minorByBlock
    .slice(0, analysedBlocks)
    .reduce((s, v) => s + v, 0);

  // 3Ô∏è‚É£ Avg minor downtime rate per block
  const avgMinorRate =
    analysedBlocks > 0 ? minorTillNow / analysedBlocks : 0;

  // 4Ô∏è‚É£ Projected downtime
  const remainingBlocks = 6 - analysedBlocks;

  const projectedDowntime =
    totalDowntimeTillNow + avgMinorRate * remainingBlocks;

  return {
    projected: Math.round(projectedDowntime),
    avgMinorRate: avgMinorRate.toFixed(1),
    analysedBlocks
  };
}
function getProjectedDowntimeStatus(projected) {

  if (projected > 120) {
    return { label: "Above Threshold", cls: "critical" };
  }

  return { label: "Below Threshold", cls: "good" };
}
function renderProjectedDowntime(rows, blocks) {

  const data = calculateProjectedDowntime(rows, blocks);
  const status = getProjectedDowntimeStatus(data.projected);

  document.getElementById("eodProjectedDown").textContent =
    `${data.projected} min`;

  document.getElementById("eodDownRate").textContent =
    `${data.avgMinorRate} min/block`;

  document.getElementById("eodDownBlocks").textContent =
    `${data.analysedBlocks} / 6`;

  document.getElementById("eodDownStatus").textContent =
    status.label;

  const box = document.getElementById("eodDownBox");
  box.classList.remove("good", "warning", "critical");
  box.classList.add(status.cls);
  document.getElementById("eodDownSoFar").textContent =
  `${blocks.slice(0, data.analysedBlocks).reduce((s,b)=>s+b.downtime,0)} min`;

}

  function calculateProjectedProduction(rows) {

  const now = new Date();

  // ‚è± Elapsed time in minutes
  const elapsedMinutes =
    now.getHours() * 60 + now.getMinutes();

  const totalDayMinutes = 24 * 60;
  const remainingMinutes =
    Math.max(totalDayMinutes - elapsedMinutes, 0);

  // üì¶ Production till now
  const productionTillNow = rows.reduce(
    (sum, r) => sum + (r.Meter_Run_Per_Min || 0),
    0
  );

  // ‚è≥ Runtime till now
  const runtimeTillNow = rows.reduce(
    (sum, r) => sum + (r.Runtime || 0),
    0
  );

  // üìà Avg production rate (runtime based)
  const avgProductionRate =
    runtimeTillNow > 0
      ? productionTillNow / runtimeTillNow
      : 0;

  // üîÆ Projected production
  const projectedProduction =
    productionTillNow + avgProductionRate * remainingMinutes;

  // üìä Expected performance
  const expectedPerformance =
    projectedProduction > 0
      ? (productionTillNow / projectedProduction) * 100
      : 0;

  return {
    projected: Math.round(projectedProduction),
    avgRate: avgProductionRate.toFixed(2),
    remainingMinutes,
    expectedPerformance: expectedPerformance.toFixed(1)
  };
}
function renderProjectedProduction(rows) {

  const data = calculateProjectedProduction(rows);

  document.getElementById("eodProjectedProd").textContent =
    data.projected;

  document.getElementById("eodProdRate").textContent =
    `${data.avgRate} mtr/min`;

  document.getElementById("eodRemainingTime").textContent =
    `${data.remainingMinutes} min`;

  document.getElementById("eodExpectedPerf").textContent =
    `${data.expectedPerformance} %`;
}

  
/* ================= AGGREGATE ================= */
function aggregate(rows){
  const blocks=[...Array(6)].map(()=>({actual:0,expected:0,downtime:0,runtime:0,p:[],o:[]}));
  rows.forEach(p=>{
    const i=Math.floor(new Date(p.ts).getHours()/4);
    const b=blocks[i];
    b.actual+=p.Meter_Run_Per_Min||0;
    b.expected+=p.deltaexpectedproduction||0;
    b.downtime+=p.Downtime||0;
    b.runtime+=p.Runtime||0;
    if(p.deltaperformance!=null)b.p.push(p.deltaperformance);
    if(p.deltaoee!=null)b.o.push(p.deltaoee);
  });
  return blocks.map(b=>{
    const perfPct=b.expected?(b.actual/b.expected)*100:0;
    let s="good";
    if(b.downtime>60)s="critical";
    else if(perfPct<90)s="warning";
    return{...b,s,perf:avg(b.p),oee:avg(b.o)};
  });
}

/* ================= RENDER ================= */
function render(blocks){
  const tl=document.getElementById("timeline");
  const dots=document.getElementById("dots");
  tl.innerHTML=""; dots.innerHTML="";
  blocks.forEach((b,i)=>{
    dots.innerHTML+=`<div class="dot ${b.s}"></div>`;
    const el=document.createElement("div");
    el.className=`block ${b.s}`;
    el.innerHTML=`
      <div class="block-header">
        <strong>${BLOCKS[i]}</strong>
        <span class="chevron">‚åÑ</span>
      </div>
      <div class="metric">Performance ${b.perf.toFixed(1)}%</div>
      <div class="metric">${Math.round(b.actual)} / ${Math.round(b.expected)} mtr</div>
      <div class="metric">Downtime ${b.downtime} min</div>
    `;
    el.onclick=()=>toggleDetails(blocks,i);
    tl.appendChild(el);
  });
}

/* ================= TOGGLE DETAILS ================= */
function toggleDetails(blocks,i){
  const d=document.getElementById("details");
  const cards=[...document.querySelectorAll(".block")];

  if(activeIndex===i){ closeDetails(); return; }

  cards.forEach(c=>c.classList.remove("active"));
  cards[i].classList.add("active");

  const b=blocks[i];
  activeIndex=i;

  d.className=`details active ${b.s}`;
  d.innerHTML=`
    <div class="details-box ${b.s}">
      <div class="details-header">
        <strong>Time Block: ${BLOCKS[i]}</strong>
        <span style="cursor:pointer" onclick="closeDetails()">√ó</span>
      </div>

      <div class="details-section-head">
        <span>üìä Production Status</span>
        <span>‚è± Downtime Status</span>
        <span>üí° Quick Insight</span>
      </div>

      <div class="details-grid">
        <div class="info-box">
          <strong>${b.actual>=b.expected?"Ahead":"Behind"} Target</strong><br>
          ${Math.abs(Math.round(b.actual-b.expected))} mtr
        </div>
        <div class="info-box">
          <strong>Total Downtime</strong><br>
          ${b.downtime} min
        </div>
        <div class="info-box">
          ${b.s==="good"
            ?"Great job! Production is on track."
            :b.s==="warning"
            ?"You're close to target. Reduce minor stoppages."
            :"Production is lagging. Focus on downtime reduction."}
        </div>
      </div>

      <button class="cta">View Detailed Analysis</button>
    </div>
  `;
const viewBtn = d.querySelector(".cta");
if (viewBtn) {
  viewBtn.onclick = () => openAnalysis({
    label: BLOCKS[i],
    actual: b.actual,
    expected: b.expected,
    perf: b.perf,
    downtime: b.downtime,
    runtime: b.runtime,
    zone: b.s === "good"
      ? "Good"
      : b.s === "warning"
        ? "Warning"
        : "Critical"
  });
}
}

function closeDetails(){
  document.getElementById("details").classList.remove("active");
  document.querySelectorAll(".block").forEach(b=>b.classList.remove("active"));
  activeIndex=null;
}

/* ================= SUMMARY ================= */
function renderSummary(blocks){
  const exp=blocks.reduce((a,b)=>a+b.expected,0);
  const act=blocks.reduce((a,b)=>a+b.actual,0);
  const down=blocks.reduce((a,b)=>a+b.downtime,0);
  const oee=avg(blocks.map(b=>b.oee));
  document.getElementById("summary").innerHTML=`
    <div class="summary-card">Total Expected<br><strong>${Math.round(exp)} mtr</strong></div>
    <div class="summary-card">Total Actual<br><strong>${Math.round(act)} mtr</strong></div>
    <div class="summary-card">Total Downtime<br><strong>${down} min</strong></div>
    <div class="summary-card">Overall Status<br><strong>${oee.toFixed(1)}%</strong></div>
  `;
}

/* ================= TIME PIN ================= */
function updateTime(blocks){
  const now=new Date();
  const m=now.getHours()*60+now.getMinutes();
  const pct=(m/1440)*100;
  document.getElementById("time-pin").style.left=pct+"%";
  document.getElementById("timeline-progress").style.width=pct+"%";
  const s=blocks[Math.floor(now.getHours()/4)]?.s||"good";
  document.querySelector(".pin-icon").className=`pin-icon pin-${s}`;
}

/* ================= LOAD ================= */
  function showLoading(){
  document.getElementById("loading").style.display="flex";
}

function hideLoading(){
  document.getElementById("loading").style.display="none";
}

async function loadTimeline(date){
  closeDetails();
  selectedDate = date;

  showLoading();                    // üîë ADD

  try {
    const raw = await fetchData(date);
    const rows = mergeTelemetry(raw);
    const blocks = aggregate(rows);
    render(blocks);
    renderSummary(blocks);
    updateTime(blocks);
    renderProjectedDowntime(rows, blocks);
    renderProjectedProduction(rows);

  } finally {
    hideLoading();                  // üîë ADD
  }
}

/* ================= DETAILED ANALYSIS MODAL ================= */
function openAnalysis(block){
  // SHOW MODAL
  const modal = document.getElementById("analysisModal");
  modal.style.display = "flex";

  // APPLY ZONE CLASS TO CARD (IMPORTANT)
  const card = modal.querySelector(".analysis-card");
  card.classList.remove("good", "warning", "critical");
  card.classList.add(block.zone.toLowerCase());

  // HEADER TEXT
  document.getElementById("modalTime").textContent =
    `Time Block: ${block.label}`;

  // STATUS PILL
  const statusEl = document.getElementById("modalStatus");
  statusEl.textContent = `Status: ${block.zone}`;

  // METRICS
  document.getElementById("mPerformance").textContent =
    `${block.perf.toFixed(1)}%`;

  document.getElementById("mActual").textContent =
    `${Math.round(block.actual)} mtr`;

  document.getElementById("mDowntime").textContent =
    `${block.downtime} min`;

  // ===== ZONE CLASSIFICATION =====
  const zoneBox = document.getElementById("zoneBox");
  const zoneHeadline = document.getElementById("zoneHeadline");
  const zoneMessage = document.getElementById("zoneMessage");
  const zoneReasonPerf = document.getElementById("zoneReasonPerf");
  const zoneReasonDown = document.getElementById("zoneReasonDown");

  zoneBox.className = "zone-box";

  if(block.zone === "Good"){
    zoneBox.classList.add("zone-good");
    zoneHeadline.textContent = "‚úî This time block is classified as GOOD";
    zoneMessage.textContent =
      "Great job! Production is on track. Keep the consistency.";

    zoneReasonPerf.textContent =
      `‚úî Performance rate ${block.perf.toFixed(1)}% exceeds target threshold`;

    zoneReasonDown.textContent =
      `‚úî Downtime ${block.downtime} minutes is within acceptable limits`;
  }

  else if(block.zone === "Warning"){
    zoneBox.classList.add("zone-warning");
    zoneHeadline.textContent = "‚ö† This time block is classified as WARNING";
    zoneMessage.textContent =
      "You're close to the target. Reducing minor stoppages can help recover.";

    zoneReasonPerf.textContent =
      `‚ö† Performance ${block.perf.toFixed(1)}% below optimal (98%)`;

    zoneReasonDown.textContent =
      `‚ö† Production shortfall of ${Math.round(block.expected - block.actual)} mtr`;
  }

  else{
    zoneBox.classList.add("zone-critical");
    zoneHeadline.textContent = "‚õî This time block is classified as CRITICAL";
    zoneMessage.textContent =
      "Production is lagging. Immediate attention required.";

    zoneReasonPerf.textContent =
      `‚õî Performance ${block.perf.toFixed(1)}% below critical threshold`;

    zoneReasonDown.textContent =
      `‚õî Downtime ${block.downtime} minutes exceeds limit`;
  }
  /* ===== DETAILED FINDINGS CALCULATIONS ===== */

// Production Analysis
const expected = block.expected;
const actual = block.actual;
const delta = actual - expected;
const deltaPct = (Math.abs(delta) / expected * 100).toFixed(1);

document.getElementById("dfExp").textContent = `${Math.round(expected)} mtr`;
document.getElementById("dfAct").textContent = `${Math.round(actual)} mtr`;

document.getElementById("dfDelta").innerHTML =
  delta >= 0
    ? `<span style="color:#15803d">Production surplus: ${Math.round(delta)} mtr (${deltaPct}%)</span>`
    : `<span style="color:#b91c1c">Production shortfall: ${Math.round(Math.abs(delta))} mtr (${deltaPct}%)</span>`;

// Downtime Analysis
const acceptableDown = 60; // min (fixed rule)
const downMargin = acceptableDown - block.downtime;

// Expected production during downtime (impact)
const rate = expected / block.runtime; // mtr per min
const impact = rate * block.downtime;

document.getElementById("dfDown").textContent = `${block.downtime} minutes`;
document.getElementById("dfLimit").textContent = `${acceptableDown} minutes`;

document.getElementById("dfMargin").innerHTML =
  downMargin >= 0
    ? `<span style="color:#15803d">Downtime margin: ${downMargin} minutes under limit</span>`
    : `<span style="color:#b91c1c">Excess downtime: ${Math.abs(downMargin)} minutes over limit</span>`;

document.getElementById("dfImpact").innerHTML =
  `Estimated impact: ${Math.round(impact)} mtr production lost`;

// Efficiency Breakdown
const prodRate = actual / block.runtime;
const targetRate = expected / block.runtime;
const variance = prodRate - targetRate;

document.getElementById("dfRun").textContent = `${block.runtime} minutes`;
document.getElementById("dfRate").textContent = `${prodRate.toFixed(2)} mtr/min`;
document.getElementById("dfTarget").textContent = `${targetRate.toFixed(2)} mtr/min`;

document.getElementById("dfVar").innerHTML =
  variance >= 0
    ? `<span style="color:#15803d">+${variance.toFixed(2)} mtr/min</span>`
    : `<span style="color:#b91c1c">${variance.toFixed(2)} mtr/min</span>`;
  /* ===== SMART RECOMMENDATIONS ===== */
const recoMain = document.getElementById("smartRecoMain");
const recoList = document.getElementById("smartRecoList");

recoList.innerHTML = "";

if(block.zone === "Good"){
  recoMain.textContent =
    "Reduce idle time during shift change.";

  recoList.innerHTML = `
    <li>Monitor for recurring minor stoppages and address patterns</li>
    <li>Optimize material flow to reduce idle time</li>
  `;
}

else if(block.zone === "Warning"){
  recoMain.textContent =
    "Investigate downtime root causes and prioritize quick fixes.";

  recoList.innerHTML = `
    <li>Conduct immediate root cause analysis of downtime events</li>
    <li>Review machine parameters and compare with optimal settings</li>
    <li>Improve operator response time during minor stoppages</li>
  `;
}

else{ // CRITICAL
  recoMain.textContent =
    "Immediate intervention required to stabilize production.";

  recoList.innerHTML = `
    <li>Escalate issue to maintenance and production supervisors</li>
    <li>Perform detailed breakdown analysis for major losses</li>
    <li>Consider scheduling preventive maintenance immediately</li>
  `;
}


}


function closeAnalysis(){
  document.getElementById("analysisModal").style.display = "none";
}
  
/* ================= BUTTONS ================= */
function setActive(btn){
  document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

btnToday.onclick = () => {
  setActive(btnToday);
  viewLabel.textContent = "Viewing: Today";
  datePicker.style.display = "none";
  loadTimeline(new Date());
};

btnYesterday.onclick = () => {
  setActive(btnYesterday);
  const d = new Date(Date.now() - 86400000);
  datePicker.style.display = "none";
  viewLabel.textContent = "Viewing: Yesterday";
  loadTimeline(d);
};

/* üîë FIX: Custom Date button click handler */
btnCustom.onclick = () => {
  setActive(btnCustom);
  datePicker.style.display = "inline-block";
  datePicker.focus();
};

datePicker.onchange = e => {
  if (!e.target.value) return;

  const d = new Date(e.target.value);
  viewLabel.textContent = `Viewing: ${e.target.value}`;
  datePicker.style.display = "none";
  loadTimeline(d);
};


/* ================= INIT ================= */
(async()=>{
  if(!JWT) return alert("JWT missing");
  await loadTimeline(new Date());
})();
</script>
</body>
</html>
