<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:#eef2f7;
}
.container{
  max-width:1400px;
  margin:24px auto;
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 16px 40px rgba(0,0,0,.1);
}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;}
.brand{font-size:22px;font-weight:700;color:#2563eb;}
.subtitle{font-size:14px;color:#64748b}

/* Controls */
.controls{display:flex;gap:10px;margin-top:16px}
.btn{padding:8px 18px;border-radius:12px;border:1px solid #c7d2fe;background:#f8fafc;font-weight:600}
.btn.active{background:#2563eb;color:#fff}

/* Timeline line */
.timeline-wrapper{position:relative;margin-top:28px}
.timeline-line{position:absolute;top:14px;left:0;right:0;height:4px;background:#e5e7eb;border-radius:2px}
.timeline-dots{display:grid;grid-template-columns:repeat(6,1fr)}
.dot{width:14px;height:14px;border-radius:50%;margin:auto;z-index:2}
.dot.good{background:#22c55e}
.dot.warning{background:#f59e0b}
.dot.critical{background:#ef4444}

/* Blocks */
.timeline{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-top:28px}
.block{
  border-radius:16px;padding:14px;border:2px solid #e5e7eb;
  background:#f9fafb;transition:.2s
}
.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}

.block-header{
  display:flex;justify-content:space-between;align-items:center;
}
.time{font-weight:700}
.status-pill{
  font-size:12px;padding:4px 10px;border-radius:999px;
  font-weight:700;color:#fff
}
.good .status-pill{background:#22c55e}
.warning .status-pill{background:#f59e0b}
.critical .status-pill{background:#ef4444}

.chevron{
  cursor:pointer;font-size:14px;transition:.2s
}
.chevron.open{transform:rotate(180deg)}

.metric{margin-top:8px;font-size:13px;color:#334155}
.metric strong{font-size:18px;color:#0f172a}

/* Expanded area */
.expand{
  display:none;margin-top:12px;padding:14px;border-radius:14px;
  background:#fff;border:1px solid #e5e7eb
}
.expand.active{display:block}

.expand-header{
  display:flex;justify-content:space-between;align-items:center;
  font-weight:600
}
.close-btn{cursor:pointer;font-weight:700}

.expand-grid{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px
}
.box{
  padding:12px;border-radius:12px;
  border:1px solid #e5e7eb
}
.good-box{background:#f0fdf4;border-color:#22c55e}
.warn-box{background:#fffbeb;border-color:#f59e0b}
.crit-box{background:#fef2f2;border-color:#ef4444}

.box h4{margin:0;font-size:13px;color:#64748b}
.box .val{margin-top:6px;font-size:18px;font-weight:700}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div>
    <div class="brand">Plantwiz</div>
    <div class="subtitle">Production Timeline</div>
  </div>
  <div class="subtitle">Viewing: Today</div>
</div>

<div class="controls">
  <div class="btn active">Current Day (Today)</div>
  <div class="btn">Yesterday</div>
  <div class="btn">Custom Date</div>
</div>

<div class="timeline-wrapper">
  <div class="timeline-line"></div>
  <div id="dots" class="timeline-dots"></div>
</div>

<div id="timeline" class="timeline"></div>

</div>

<script>
const API_BASE="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=["Meter_Run_Per_Min","deltaexpectedproduction","Downtime","deltaperformance"];
const BLOCKS=["00–04","04–08","08–12","12–16","16–20","20–24"];
const JWT=new URLSearchParams(location.search).get("token");

const num=v=>Number(v)||0;
const avg=a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0;
const getHourIST=ts=>new Date(ts+19800000).getUTCHours();
const blockIndex=ts=>Math.floor(getHourIST(ts)/4);

async function fetchData(){
 const d=new Date();
 const s=new Date(d.toDateString()).getTime();
 const e=s+86400000-1;
 const url=`${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${s}&endTs=${e}&agg=NONE&limit=5000`;
 const r=await fetch(url,{headers:{"X-Authorization":"Bearer "+JWT}});
 return r.json();
}

function merge(obj){
 const m=new Map();
 Object.entries(obj).forEach(([k,a])=>{
  (a||[]).forEach(p=>{
   const r=m.get(p.ts)||{ts:p.ts};
   r[k]=Number(p.value);
   m.set(p.ts,r);
  });
 });
 return [...m.values()];
}

function aggregate(rows){
 const b=Array.from({length:6},()=>({a:0,e:0,d:0,p:[]}));
 rows.forEach(r=>{
  const i=blockIndex(r.ts),x=b[i];
  x.a+=num(r.Meter_Run_Per_Min);
  x.e+=num(r.deltaexpectedproduction);
  x.d+=num(r.Downtime);
  if(r.deltaperformance!=null)x.p.push(r.deltaperformance);
 });
 return b.map(x=>{
  const perf=avg(x.p);
  let s="good";
  if(x.d>60)s="critical";
  else if(perf<90)s="warning";
  return {...x,perf,s};
 });
}

function render(blocks){
 const tl=document.getElementById("timeline");
 const dots=document.getElementById("dots");
 tl.innerHTML=""; dots.innerHTML="";
 blocks.forEach((b,i)=>{
  dots.innerHTML+=`<div class="dot ${b.s}"></div>`;
  const diff=b.a-b.e;
  const el=document.createElement("div");
  el.className=`block ${b.s}`;
  el.innerHTML=`
   <div class="block-header">
    <div class="time">${BLOCKS[i]}</div>
    <div style="display:flex;gap:6px;align-items:center">
      <div class="status-pill">${b.s.toUpperCase()}</div>
      <div class="chevron">▼</div>
    </div>
   </div>
   <div class="metric">Performance<br><strong>${b.perf.toFixed(1)}%</strong></div>
   <div class="metric">${b.a} / ${b.e}</div>
   <div class="metric">Target ${b.e} | Downtime ${b.d} min</div>

   <div class="expand">
    <div class="expand-header">
      <div>Time Block: ${BLOCKS[i]}</div>
      <div class="close-btn">✕</div>
    </div>
    <div class="expand-grid">
      <div class="box ${b.s}-box">
        <h4>Production Status</h4>
        <div class="val">${diff>=0?"Ahead":"Behind"} ${Math.abs(diff)} pcs</div>
      </div>
      <div class="box ${b.s}-box">
        <h4>Downtime</h4>
        <div class="val">${b.d} minutes</div>
      </div>
      <div class="box ${b.s}-box">
        <h4>Quick Insight</h4>
        <div class="val">${
          b.s==="good"?"Great job! Production on track.":
          b.s==="warning"?"Reduce minor stoppages to improve.":
          "High downtime detected. Immediate action required."
        }</div>
      </div>
    </div>
   </div>
  `;

  const chevron=el.querySelector(".chevron");
  const expand=el.querySelector(".expand");
  const close=el.querySelector(".close-btn");

  function collapseAll(){
    document.querySelectorAll(".expand").forEach(e=>e.classList.remove("active"));
    document.querySelectorAll(".chevron").forEach(c=>c.classList.remove("open"));
  }

  chevron.onclick=()=>{
    const open=expand.classList.contains("active");
    collapseAll();
    if(!open){
      expand.classList.add("active");
      chevron.classList.add("open");
    }
  };
  close.onclick=collapseAll;

  tl.appendChild(el);
 });
}

(async()=>{
 if(!JWT)return alert("JWT missing");
 const raw=await fetchData();
 const rows=merge(raw);
 const blocks=aggregate(rows);
 render(blocks);
})();
</script>
</body>
</html>
