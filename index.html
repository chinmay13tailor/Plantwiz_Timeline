<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
/* ===================== BASE ===================== */
body{
  margin:0;
  font-family:Inter,Segoe UI,Roboto,sans-serif;
  background:#f4f7fb;
}
.container{
  max-width:1400px;
  margin:20px auto;
  padding:24px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.08);
}

/* ===================== HEADER ===================== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  font-size:22px;
  font-weight:700;
  color:#2563eb;
}
.subtitle{
  font-size:14px;
  color:#64748b;
}

/* ===================== CONTROLS ===================== */
.controls{
  display:flex;
  gap:10px;
  margin:18px 0 10px;
}
.btn{
  padding:8px 16px;
  border-radius:10px;
  border:1px solid #c7d2fe;
  background:#f8fafc;
  font-weight:600;
  cursor:pointer;
}
.btn.active{
  background:#2563eb;
  color:#fff;
}

/* Custom Date Picker */
#datePicker{
  display:none;
  margin-bottom:16px;
}
#datePicker input{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  font-size:14px;
}

/* ===================== TIMELINE LINE ===================== */
.timeline-line{
  position:relative;
  height:6px;
  background:#e5e7eb;
  border-radius:6px;
  overflow:hidden;
  margin-bottom:22px;
}
.timeline-progress{
  position:absolute;
  left:0;
  top:0;
  height:100%;
  background:linear-gradient(90deg,#3b82f6,#60a5fa,#3b82f6);
  background-size:200px 100%;
  animation:flow 3s linear infinite;
}
@keyframes flow{
  from{background-position:0 0}
  to{background-position:200px 0}
}
.timeline-pin{
  position:absolute;
  top:-14px;
  transform:translateX(-50%);
  font-size:20px;
}

/* ===================== BLOCKS ===================== */
.timeline{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:16px;
}
.block{
  border-radius:14px;
  padding:14px;
  border:2px solid #e5e7eb;
  background:#f9fafb;
  cursor:pointer;
  transition:.25s ease;
}
.block:hover{
  transform:translateY(-4px);
}
.block.active{
  transform:translateY(-6px);
}

.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}

.block-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
  font-size:14px;
}
.metric{
  margin-top:8px;
  font-size:13px;
  color:#334155;
}

/* ===================== DETAILS SLIDE ===================== */
.details{
  overflow:hidden;
  max-height:0;
  transition:max-height .6s ease;
}
.details.active{
  max-height:420px;
  margin-top:20px;
}
.details-box{
  border-radius:16px;
  padding:20px;
}
.details.good{border:2px solid #22c55e;background:#ecfdf5}
.details.warning{border:2px solid #f59e0b;background:#fffbeb}
.details.critical{border:2px solid #ef4444;background:#fef2f2}

.details-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
  margin-bottom:12px;
}
.details-header button{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
}

.details-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}
.section-title{
  font-size:13px;
  font-weight:600;
  color:#475569;
  margin-bottom:6px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  border:1px solid #e5e7eb;
  font-size:14px;
}

/* ===================== SUMMARY ===================== */
.summary{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-top:22px;
}
.summary .card{
  text-align:center;
  font-weight:600;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div>
      <div class="brand">Plantwiz</div>
      <div class="subtitle">Production Timeline</div>
    </div>
    <div class="subtitle" id="viewLabel">Viewing: Today</div>
  </div>

  <div class="controls">
    <button class="btn active" id="btnToday">Current Day (Today)</button>
    <button class="btn" id="btnYesterday">Yesterday</button>
    <button class="btn" id="btnCustom">Custom Date</button>
  </div>

  <div id="datePicker">
    <input type="date" id="customDate">
  </div>

  <div class="timeline-line">
    <div class="timeline-progress" id="progress"></div>
    <div class="timeline-pin" id="pin">üìç</div>
  </div>

  <div class="timeline" id="timeline"></div>
  <div class="details" id="details"></div>
  <div class="summary" id="summary"></div>

</div>

<script>
/* ===================== CONFIG ===================== */
const API_BASE="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=[
 "Meter_Run_Per_Min","Consumption_Per_Min","deltaexpectedproduction",
 "Runtime","Downtime","Idletime",
 "deltaperformance","deltaavailability","deltaquality","deltaoee"
];
const BLOCKS=["00‚Äì04","04‚Äì08","08‚Äì12","12‚Äì16","16‚Äì20","20‚Äì24"];

const JWT=new URLSearchParams(location.search).get("token");
if(!JWT){alert("JWT token missing");}

let activeIndex=null;
let selectedMode="today";

/* ===================== DATE HELPERS ===================== */
function getDayRange(d){
  const s=new Date(d); s.setHours(0,0,0,0);
  const e=new Date(d); e.setHours(23,59,59,999);
  return {startTs:s.getTime(),endTs:e.getTime()};
}

/* ===================== FETCH ===================== */
async function fetchTelemetry(range){
  const url=`${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${range.startTs}&endTs=${range.endTs}&agg=NONE&limit=5000`;
  const r=await fetch(url,{headers:{'X-Authorization':`Bearer ${JWT}`}});
  return r.json();
}

/* ===================== AGGREGATION ===================== */
function aggregate(rows){
  const blocks=Array.from({length:6},()=>({
    actual:0,expected:0,downtime:0,oee:[]
  }));

  Object.values(rows).flat().forEach(p=>{
    const i=Math.floor(new Date(p.ts).getHours()/4);
    blocks[i].actual+=+p.Meter_Run_Per_Min||0;
    blocks[i].expected+=+p.deltaexpectedproduction||0;
    blocks[i].downtime+=+p.Downtime||0;
    if(p.deltaoee!=null) blocks[i].oee.push(+p.deltaoee);
  });

  return blocks.map(b=>{
    const perf=b.expected?b.actual/b.expected*100:0;
    let status="good";
    if(b.downtime>60) status="critical";
    else if(perf<90) status="warning";
    return {
      ...b,
      perf,
      status,
      oee:b.oee.length?b.oee.reduce((a,c)=>a+c,0)/b.oee.length:0
    };
  });
}

/* ===================== RENDER ===================== */
function renderTimeline(blocks){
  const tl=document.getElementById("timeline");
  tl.innerHTML="";
  blocks.forEach((b,i)=>{
    const el=document.createElement("div");
    el.className=`block ${b.status} ${activeIndex===i?"active":""}`;
    el.innerHTML=`
      <div class="block-header">${BLOCKS[i]} <span>‚ñæ</span></div>
      <div class="metric">Performance ${b.perf.toFixed(1)}%</div>
      <div class="metric">${Math.round(b.actual)} / ${Math.round(b.expected)} mtr</div>
      <div class="metric">Downtime ${b.downtime} min</div>`;
    el.onclick=()=>toggleDetails(blocks,i);
    tl.appendChild(el);
  });
}

/* ===================== DETAILS ===================== */
function toggleDetails(blocks,i){
  const d=document.getElementById("details");
  if(activeIndex===i){
    d.classList.remove("active");
    activeIndex=null;
    return;
  }
  activeIndex=i;
  const b=blocks[i];
  d.className=`details active`;
  d.innerHTML=`
    <div class="details-box ${b.status}">
      <div class="details-header">
        Time Block: ${BLOCKS[i]}
        <button onclick="toggleDetails([],${i})">‚úï</button>
      </div>
      <div class="details-grid">
        <div>
          <div class="section-title">Production Status</div>
          <div class="card">${Math.round(Math.abs(b.actual-b.expected))} mtr ${b.actual>=b.expected?"Ahead":"Behind"} Target</div>
        </div>
        <div>
          <div class="section-title">Downtime Status</div>
          <div class="card">${b.downtime} min</div>
        </div>
        <div>
          <div class="section-title">Quick Insight</div>
          <div class="card">${b.status==="good"?"Great job! Production is on track.":"Focus on reducing downtime."}</div>
        </div>
      </div>
    </div>`;
  renderTimeline(blocks);
}

/* ===================== SUMMARY ===================== */
function renderSummary(blocks){
  const exp=blocks.reduce((a,b)=>a+b.expected,0);
  const act=blocks.reduce((a,b)=>a+b.actual,0);
  const dt=blocks.reduce((a,b)=>a+b.downtime,0);
  const oee=blocks.reduce((a,b)=>a+b.oee,0)/blocks.length;
  document.getElementById("summary").innerHTML=`
    <div class="card">Total Expected<br>${Math.round(exp)} mtr</div>
    <div class="card">Total Actual<br>${Math.round(act)} mtr</div>
    <div class="card">Total Downtime<br>${dt} min</div>
    <div class="card">Overall Status<br>${oee.toFixed(1)}%</div>`;
}

/* ===================== LOAD ===================== */
async function load(range,label){
  document.getElementById("viewLabel").innerText="Viewing: "+label;
  const raw=await fetchTelemetry(range);
  const blocks=aggregate(raw);
  renderTimeline(blocks);
  renderSummary(blocks);
}

/* ===================== BUTTONS ===================== */
btnToday.onclick=()=>{
  setActive(btnToday);
  datePicker.style.display="none";
  selectedMode="today";
  load(getDayRange(new Date()),"Today");
};
btnYesterday.onclick=()=>{
  setActive(btnYesterday);
  datePicker.style.display="none";
  selectedMode="yesterday";
  const d=new Date(); d.setDate(d.getDate()-1);
  load(getDayRange(d),"Yesterday");
};
btnCustom.onclick=()=>{
  setActive(btnCustom);
  datePicker.style.display="block";
};
customDate.onchange=()=>{
  selectedMode="custom";
  load(getDayRange(customDate.value),"Custom Date");
};

function setActive(btn){
  document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ===================== INIT ===================== */
btnToday.click();
</script>
</body>
</html>
