<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Plantwiz | Production Timeline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================= BASE ================= */
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  background:#eef2f7;
}
.container{
  max-width:1400px;
  margin:24px auto;
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 16px 40px rgba(0,0,0,.1);
}

/* ================= HEADER ================= */
.header{display:flex;justify-content:space-between;align-items:center;}
.brand{font-size:22px;font-weight:700;color:#2563eb;}
.subtitle{font-size:14px;color:#64748b}

/* ================= CONTROLS ================= */
.controls{display:flex;gap:10px;margin-top:16px}
.btn{
  padding:8px 18px;border-radius:12px;
  border:1px solid #c7d2fe;background:#f8fafc;font-weight:600
}
.btn.active{background:#2563eb;color:#fff}

/* ================= TIMELINE LINE ================= */
.timeline-wrapper{position:relative;margin-top:28px}
.timeline-line{
  position:absolute;top:14px;left:0;right:0;
  height:4px;background:#e5e7eb;border-radius:2px
}
.timeline-dots{
  display:grid;grid-template-columns:repeat(6,1fr)
}
.dot{
  width:14px;height:14px;border-radius:50%;
  margin:auto;z-index:2
}
.dot.good{background:#22c55e}
.dot.warning{background:#f59e0b}
.dot.critical{background:#ef4444}

/* ================= BLOCKS ================= */
.timeline{
  display:grid;grid-template-columns:repeat(6,1fr);
  gap:14px;margin-top:28px
}
.block{
  border-radius:16px;padding:14px;
  border:2px solid #e5e7eb;
  background:#f9fafb;
  cursor:pointer;transition:.2s
}
.block.good{border-color:#22c55e;background:#f0fdf4}
.block.warning{border-color:#f59e0b;background:#fffbeb}
.block.critical{border-color:#ef4444;background:#fef2f2}
.block.selected{box-shadow:0 0 0 3px rgba(37,99,235,.25)}

.block-header{
  display:flex;justify-content:space-between;align-items:center
}
.time{font-weight:700}
.status-pill{
  font-size:12px;padding:4px 10px;
  border-radius:999px;font-weight:700;color:#fff
}
.good .status-pill{background:#22c55e}
.warning .status-pill{background:#f59e0b}
.critical .status-pill{background:#ef4444}
.chevron{font-size:14px;transition:.2s}
.block.selected .chevron{transform:rotate(180deg)}

.metric{margin-top:8px;font-size:13px;color:#334155}
.metric strong{font-size:18px;color:#0f172a}

/* ================= DETAIL PANEL ================= */
.detail{
  display:none;margin-top:26px;
  border-radius:18px;padding:18px;
  border:2px solid #e5e7eb
}
.detail.good{border-color:#22c55e;background:#f0fdf4}
.detail.warning{border-color:#f59e0b;background:#fffbeb}
.detail.critical{border-color:#ef4444;background:#fef2f2}

.detail-header{
  display:flex;justify-content:space-between;align-items:center
}
.detail-title{font-weight:700}
.close-btn{cursor:pointer;font-size:18px;font-weight:700}

.detail-grid{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:14px;margin-top:14px
}
.box{
  background:#fff;border-radius:14px;
  padding:14px;border:1px solid #e5e7eb
}
.box h4{margin:0;font-size:13px;color:#64748b}
.box .val{margin-top:6px;font-size:18px;font-weight:700}

.cta{
  margin-top:14px;
  background:#2563eb;color:#fff;
  padding:10px 18px;border-radius:12px;
  font-weight:600;display:inline-block
}

/* ================= SUMMARY ================= */
.summary{
  margin-top:26px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}
.sum-card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  border:1px solid #e5e7eb;
  text-align:center;
}
.sum-card h4{
  margin:0;
  font-size:13px;
  color:#64748b;
}
.sum-card .val{
  margin-top:8px;
  font-size:22px;
  font-weight:800;
}
.sum-card.green{background:#f0fdf4;border-color:#22c55e}
.sum-card.yellow{background:#fffbeb;border-color:#f59e0b}
.sum-card.red{background:#fef2f2;border-color:#ef4444}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div>
    <div class="brand">Plantwiz</div>
    <div class="subtitle">Production Timeline</div>
  </div>
  <div class="subtitle">Viewing: Today</div>
</div>

<div class="controls">
  <div class="btn active">Current Day (Today)</div>
  <div class="btn">Yesterday</div>
  <div class="btn">Custom Date</div>
</div>

<div class="timeline-wrapper">
  <div class="timeline-line"></div>
  <div id="dots" class="timeline-dots"></div>
</div>

<div id="timeline" class="timeline"></div>

<!-- DETAIL PANEL -->
<div id="detail" class="detail"></div>

<!-- SUMMARY -->
<div id="summary" class="summary"></div>

</div>

<script>
const API_BASE="https://plantwiz.pimateck.in/api";
const DEVICE_ID="81261350-b886-11f0-87ea-b9809c1a7a9e";
const KEYS=[
  "Meter_Run_Per_Min",
  "deltaexpectedproduction",
  "Downtime",
  "deltaperformance",
  "deltaoee"
];
const BLOCKS=["00–04","04–08","08–12","12–16","16–20","20–24"];
const JWT=new URLSearchParams(location.search).get("token");

const num=v=>Number(v)||0;
const avg=a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0;
const getHourIST=ts=>new Date(ts+19800000).getUTCHours();
const blockIndex=ts=>Math.floor(getHourIST(ts)/4);

async function fetchData(){
 const d=new Date(),s=new Date(d.toDateString()).getTime(),e=s+86400000-1;
 const url=`${API_BASE}/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=${KEYS.join(",")}&startTs=${s}&endTs=${e}&agg=NONE&limit=5000`;
 const r=await fetch(url,{headers:{"X-Authorization":"Bearer "+JWT}});
 return r.json();
}

function merge(obj){
 const m=new Map();
 Object.entries(obj).forEach(([k,a])=>{
  (a||[]).forEach(p=>{
   const r=m.get(p.ts)||{ts:p.ts};
   r[k]=Number(p.value);
   m.set(p.ts,r);
  });
 });
 return [...m.values()];
}

function aggregate(rows){
 const b=Array.from({length:6},()=>({a:0,e:0,d:0,p:[]}));
 rows.forEach(r=>{
  const i=blockIndex(r.ts),x=b[i];
  x.a+=num(r.Meter_Run_Per_Min);
  x.e+=num(r.deltaexpectedproduction);
  x.d+=num(r.Downtime);
  if(r.deltaperformance!=null)x.p.push(r.deltaperformance);
 });
 return b.map(x=>{
  const perf=avg(x.p);
  let s="good";
  if(x.d>60)s="critical";
  else if(perf<90)s="warning";
  return {...x,perf,s};
 });
}

function calculateTotals(rows){
 let totalExpected=0,totalActual=0,totalDowntime=0,oee=[];
 rows.forEach(r=>{
  totalExpected+=num(r.deltaexpectedproduction);
  totalActual+=num(r.Meter_Run_Per_Min);
  totalDowntime+=num(r.Downtime);
  if(r.deltaoee!=null)oee.push(r.deltaoee);
 });
 return{
  totalExpected,
  totalActual,
  totalDowntime,
  avgOEE:avg(oee)
 };
}

let activeIndex=null;

function render(blocks){
 const tl=document.getElementById("timeline");
 const dots=document.getElementById("dots");
 const detail=document.getElementById("detail");
 tl.innerHTML="";dots.innerHTML="";

 blocks.forEach((b,i)=>{
  dots.innerHTML+=`<div class="dot ${b.s}"></div>`;
  const el=document.createElement("div");
  el.className=`block ${b.s}`;
  el.innerHTML=`
   <div class="block-header">
     <div class="time">${BLOCKS[i]}</div>
     <div style="display:flex;gap:6px;align-items:center">
       <div class="status-pill">${b.s.toUpperCase()}</div>
       <div class="chevron">▼</div>
     </div>
   </div>
   <div class="metric">Performance<br><strong>${b.perf.toFixed(1)}%</strong></div>
   <div class="metric">${b.a} / ${b.e}</div>
   <div class="metric">Target ${b.e} | Downtime ${b.d} min</div>
  `;

  el.onclick=()=>{
    if(activeIndex===i){
      detail.style.display="none";
      document.querySelectorAll(".block").forEach(x=>x.classList.remove("selected"));
      activeIndex=null;
      return;
    }
    activeIndex=i;
    document.querySelectorAll(".block").forEach(x=>x.classList.remove("selected"));
    el.classList.add("selected");

    const diff=b.a-b.e;
    detail.className=`detail ${b.s}`;
    detail.style.display="block";
    detail.innerHTML=`
      <div class="detail-header">
        <div class="detail-title">Time Block: ${BLOCKS[i]} | Status: ${b.s.toUpperCase()}</div>
        <div class="close-btn">✕</div>
      </div>
      <div class="detail-grid">
        <div class="box">
          <h4>Production Status</h4>
          <div class="val">${diff>=0?"Ahead":"Behind"} ${Math.abs(diff)} pcs</div>
        </div>
        <div class="box">
          <h4>Downtime Status</h4>
          <div class="val">${b.d} minutes</div>
        </div>
        <div class="box">
          <h4>Quick Insight</h4>
          <div class="val">${
            b.s==="good"?"Great job! Production is on track.":
            b.s==="warning"?"You're close to target. Reduce minor stoppages.":
            "Production is lagging. Focus on reducing downtime."
          }</div>
        </div>
      </div>
      <div class="cta">View Detailed Analysis</div>
    `;
    detail.querySelector(".close-btn").onclick=()=>{
      detail.style.display="none";
      el.classList.remove("selected");
      activeIndex=null;
    };
  };
  tl.appendChild(el);
 });
}

function renderSummary(t){
 const s=document.getElementById("summary");
 let cls="green";
 if(t.avgOEE<80)cls="red";
 else if(t.avgOEE<90)cls="yellow";

 s.innerHTML=`
  <div class="sum-card">
    <h4>Total Expected</h4>
    <div class="val">${t.totalExpected.toLocaleString()}</div>
    <div class="subtitle">pieces</div>
  </div>
  <div class="sum-card">
    <h4>Total Actual</h4>
    <div class="val">${t.totalActual.toLocaleString()}</div>
    <div class="subtitle">pieces</div>
  </div>
  <div class="sum-card yellow">
    <h4>Total Downtime</h4>
    <div class="val">${t.totalDowntime}</div>
    <div class="subtitle">minutes</div>
  </div>
  <div class="sum-card ${cls}">
    <h4>Overall Status</h4>
    <div class="val">${t.avgOEE.toFixed(1)}%</div>
    <div class="subtitle">efficiency</div>
  </div>
 `;
}

(async()=>{
 if(!JWT)return alert("JWT missing");
 const raw=await fetchData();
 const rows=merge(raw);
 const blocks=aggregate(rows);
 render(blocks);
 const totals=calculateTotals(rows);
 renderSummary(totals);
})();
</script>
</body>
</html>
